---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# `r paste(input$reportTitle, sep="")`  
## `r paste(format(Sys.Date(), "%B %d, %Y"), sep="")`

This report was generated using the PrEP Indications Estimation Tool. The tool was created as part of a partnership between the Centers for Disease Control and Prevention (CDC) and researchers at Emory University's Rollins School of Public Health.

## Assumptions and Results
The following estimates were based on several model inputs and assumptions. First, the total number of MSM in the model population was set to `r paste(format(input$msmpopsize, big.mark = ","), sep = "")`. Under the assumptions specified, that `r paste(round(as.numeric(input$msmdiagpct, 2)), "%", sep = "")` of newly diagnosed cases were attributable to MSM, `r paste(round(as.numeric(input$hetdiagpct, 2)), "%", sep = "")` of newly diagnosed cases were attributable to heterosexuals (HET), and `r paste(round(as.numeric(input$pwiddiagpct, 2)), "%", sep = "")` of newly diagnosed cases were attributable to persons who inject drugs (PWID), the total number of individuals with indications for PrEP is `r paste(format(input$totalprep, big.mark = ","), sep = "")`. The estimated number of MSM  with indications for PrEP is `r paste(format(input$msmprep, big.mark = ","), sep = "")`, the estimated number of heterosexuals  with indications for PrEP is `r paste(format(input$hetprep, big.mark = ","), sep = "")`, and the estimated number of heterosexuals  with indications for PrEP is `r paste(format(input$pwidprep, big.mark = ","), sep = "")`.

## Race-specific Assumptions
To generate race-specific estimates of the number of individuals within each transmission risk group who have indications for PrEP, the following assumptions were used:
`r paste(format(round(as.numeric(input$blackmsmdiagpct), 2), big.mark = ","), "%", sep = "")` of newly diagnosed cases among MSM occurred among African-American MSM,
`r paste(format(round(as.numeric(input$hispmsmdiagpct), 2), big.mark = ","), "%", sep = "")` of newly diagnosed cases among MSM occurred among Hispanic MSM,
`r paste(format(round(as.numeric(input$whitemsmdiagpct), 2), big.mark = ","), "%", sep = "")` of newly diagnosed cases among MSM occurred among White MSM,
`r paste(format(round(as.numeric(input$blackhetdiagpct), 2), big.mark = ","), "%", sep = "")` of newly diagnosed cases among heterosexuals occurred among African-American heterosexuals,
`r paste(format(round(as.numeric(input$hisphetdiagpct), 2), big.mark = ","), "%", sep = "")` of newly diagnosed cases among heterosexuals occurred among Hispanic heterosexuals,
`r paste(format(round(as.numeric(input$whitehetdiagpct), 2), big.mark = ","), "%", sep = "")` of newly diagnosed cases among heterosexuals occurred among White heterosexuals,
`r paste(format(round(as.numeric(input$blackpwiddiagpct), 2), big.mark = ","), "%", sep = "")` of newly diagnosed cases among PWID occurred among African-American PWID,
`r paste(format(round(as.numeric(input$hisppwiddiagpct), 2), big.mark = ","), "%", sep = "")` of newly diagnosed cases among PWID occurred among Hispanic PWID,
`r paste(format(round(as.numeric(input$whitepwiddiagpct), 2), big.mark = ","), "%", sep = "")` of newly diagnosed cases among PWID occurred among White PWID. 


## Results
Under these assumptions, the estimated number of African-American MSM with indications for PrEP is `r paste(format(input$blackmsmprep, big.mark = ","), sep = "")`, the estimated number of Hispanic MSM with indications for PrEP is `r paste(format(input$hispmsmprep, big.mark = ","), sep = "")`, and the estimated number of White MSM  with indications for PrEP is `r paste(format(input$whitemsmprep, big.mark = ","), sep = "")`. The estimated number of African-American heterosexuals with indications for PrEP is `r paste(format(input$blackhetprep, big.mark = ","), sep = "")`, the estimated number of Hispanic heterosexuals with indications for PrEP is `r paste(format(input$hisphetprep, big.mark = ","), sep = "")`, and the estimated number of White heterosexuals with indications for PrEP is `r paste(format(input$whitehetprep, big.mark = ","), sep = "")`. The estimated number of African-American PWID with indications for PrEP is `r paste(format(input$blackpwidprep, big.mark = ","), sep = "")`, the estimated number of Hispanic PWID with indications for PrEP is `r paste(format(input$hisppwidprep, big.mark = ","), sep = "")`, and the estimated number of White PWID with indications for PrEP is `r paste(format(input$whitepwidprep, big.mark = ","), sep = "")`.

The remaining sections of this report display the outputs from this model. The first section shows the estimated HIV Care Continuum described above, while the second section shows the estimated number of HIV transmissions based on that continuum.

```{r echo = FALSE}
library(shiny)
library(shinydashboard)
library(rsconnect)
library(shinythemes)
library(knitr)
library(rmarkdown)
library(ggplot2)
library(plyr)
library(dplyr)
library(kableExtra)
library(magrittr)
library(tinytex)
```

## Tables and Figures

### Table 1: Individuals with Indications for PrEP by Transmission Risk Group

```{r echo = FALSE, message = FALSE} 
df <- matrix(nrow = 3, ncol = 3)
class <- c("MSM", "Heterosexuals", "Persons Who Inject Drugs")
num <- c(input$msmprep, input$hetprep, input$pwidprep)
perc <- c(input$msmdiagpct, input$hetdiagpct, input$pwiddiagpct)
colnames(df) <- c("Transmission Risk Group", "Number with PrEP Indications", "Percent (%) of Total")
df[ , 1:3] <- c(class, num, perc)

# kable(df)

df_footnote <- df
df_footnote[3, 1] <- paste0(df_footnote[3, 1],
                                   footnote_marker_alphabet(1))
kable(df_footnote, "html", escape = FALSE) %>%
kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = F) %>%
footnote(alphabet = "Footnote for PWID; ",
           footnote_as_chunk = T)
```

### Figure 1: Number by Transmission Risk Group

```{r echo = FALSE, message = FALSE, fig.cap=paste("Figure 1: Individuals Indicated for PrEP by Transmission Risk Group"), fig.width=8, fig.height=8}
transnums <- NULL
transnums$Individuals <- rbind(input$msmprep, input$hetprep, input$pwidprep)
transnums$Group <- c("MSM", "HET", "PWID")
transnums2 <- as.data.frame(transnums)
ggplot(data = transnums2, aes(x = Group, y = Individuals, fill = Group)) +
  geom_bar(stat = "identity") +
  scale_fill_manual("Transmission Risk Group", values = c("darkblue","red", "green")) +
  geom_text(aes(label = Individuals), vjust = 1.6, color = "white", size = 7) +
  theme_bw() + labs(title = "Individuals Indicated for PrEP by Transmission Risk Group", 
         x = "Risk Group", y = "Number of Individuals") +
  theme(title = element_text(size = 15),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 11),
        legend.text = element_text(size = 9)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
```


### Table 2: Individuals with Indications for PrEP by Race

```{r echo = FALSE, message = FALSE}
df <- matrix(nrow = 3, ncol = 2)
class <- c("Black", "Hispanic", "White")
num <- c(sum(input$blackmsmprep, input$blackhetprep, input$blackpwidprep),
       sum(input$hispmsmprep, input$hisphetprep, input$hisppwidprep),
       sum(input$whitemsmprep, input$whitehetprep, input$whitepwidprep))
colnames(df) <- c("Race", "Number with PrEP Indications")
df[ , 1:2] <- c(class, num)

# kable(df)

df_footnote <- df
df_footnote[3, 1] <- paste0(df_footnote[3, 1],
                                   footnote_marker_alphabet(1))
kable(df_footnote, "html", escape = FALSE) %>%
kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = F) %>%
footnote(alphabet = "Footnote for PWID; ",
           footnote_as_chunk = T)
```

### Figure 2: Individuals with Indications for PrEP by Race

```{r echo=FALSE, message = FALSE, fig.cap=paste("Figure 2: MSM Indicated for PrEP by Race"), fig.width=8, fig.height=8}
msmnums <- NULL
msmnums$Individuals <- rbind(sum(input$blackmsmprep, input$blackhetprep, input$blackpwidprep),
                               sum(input$hispmsmprep, input$hisphetprep, input$hisppwidprep),
                               sum(input$whitemsmprep, input$whitehetprep, input$whitepwidprep))
msmnums$Group <- c("Black", "Hispanic", "White")
msmnums2 <- as.data.frame(msmnums)
ggplot(data = msmnums2, aes(x = Group, y = Individuals, fill = Group)) +
  geom_bar(stat = "identity") +
  scale_fill_manual("Race", values = c("darkblue","red", "green")) +
  geom_text(aes(label = Individuals), vjust = 1.6, color = "white", size = 7) +
  theme_bw() + labs(title = "Individuals Indicated for PrEP by Race", 
         x = "Race", y = "Number of Individuals") +
  theme(title = element_text(size = 15),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 11),
        legend.text = element_text(size = 9)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Table 3: Individuals with Indications for PrEP by Race among MSM Transmission Risk Group

```{r echo = FALSE, message = FALSE}
df <- matrix(nrow = 3, ncol = 3)
class <- c("Black MSM", "Hispanic MSM", "White MSM")
num <- c(input$blackmsmprep, input$hispmsmprep, input$whitemsmprep)
perc <- c(input$blackmsmdiagpct, input$hispmsmdiagpct, input$whitemsmdiagpct)
colnames(df) <- c("Race", "Number with PrEP Indications", "Percent (%) of Total MSM diagnoses")
df[ , 1:3] <- c(class, num, perc)

# kable(df)

df_footnote <- df
df_footnote[3, 1] <- paste0(df_footnote[3, 1],
                                   footnote_marker_alphabet(1))
kable(df_footnote, "html", escape = FALSE) %>%
kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = F) %>%
footnote(alphabet = "Footnote for PWID; ",
           footnote_as_chunk = T)
```

### Figure 3: Individuals with Indications for PrEP by Race among MSM Transmission Risk Group

```{r echo=FALSE, message = FALSE, fig.cap=paste("Figure 3: MSM Indicated for PrEP by Race"), fig.width=8, fig.height=8}
msmnums <- NULL
msmnums$Individuals <- rbind(input$blackmsmprep, input$hispmsmprep, input$whitemsmprep)
msmnums$Group <- c("Black", "Hispanic", "White")
msmnums2 <- as.data.frame(msmnums)
ggplot(data = msmnums2, aes(x = Group, y = Individuals, fill = Group)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Individuals), vjust = 1.6, color = "white", size = 7) +
  scale_fill_manual("Race", values = c("darkblue","red", "green")) +
  theme_minimal() + labs(title = "MSM Indicated for PrEP by Race", 
         x = "Race", y = "Number of MSM") +
  theme(title = element_text(size = 15),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 11),
        legend.text = element_text(size = 9)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Table 4: Individuals with Indications for PrEP by Race among HET Transmission Risk Group

```{r echo = FALSE, message = FALSE} 
df <- matrix(nrow = 3, ncol = 3)
class <- c("Black HET", "Hispanic HET", "White HET")
num <- c(input$blackhetprep, input$hisphetprep, input$whitehetprep)
perc <- c(input$blackhetdiagpct, input$hisphetdiagpct, input$whitehetdiagpct)
colnames(df) <- c("Race", "Number with PrEP Indications", "Percent (%) of Total HET diagnoses")
df[ , 1:3] <- c(class, num, perc)

# kable(df)

df_footnote <- df
df_footnote[3, 1] <- paste0(df_footnote[3, 1],
                                   footnote_marker_alphabet(1))
kable(df_footnote, "html", escape = FALSE) %>%
kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = F) %>%
footnote(alphabet = "Footnote for PWID; ",
           footnote_as_chunk = T)
```

### Figure 4: Individuals with Indications for PrEP by Race among HET Transmission Risk Group

```{r echo=FALSE, message = FALSE, fig.cap=paste("Figure 4: Heterosexuals Indicated for PrEP by Race"), fig.width=8, fig.height=8}
hetnums <- NULL
hetnums$Individuals <- rbind(input$blackhetprep, input$hisphetprep, input$whitehetprep)
hetnums$Group <- c("Black", "Hispanic", "White")
hetnums2 <- as.data.frame(hetnums)
ggplot(data = hetnums2, aes(x = Group, y = Individuals, fill = Group)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Individuals), vjust = 1.6, color = "white", size = 7) +
  scale_fill_manual("Race", values = c("darkblue","red", "green")) +
  theme_minimal() + labs(title = "HET Indicated for PrEP by Race", 
         x = "Race", y = "Number of HET") +
  theme(title = element_text(size = 15),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 11),
        legend.text = element_text(size = 9)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Table 5: Individuals with Indications for PrEP by Race among PWID Transmission Risk Group

```{r echo = FALSE, message = FALSE} 
df <- matrix(nrow = 3, ncol = 3)
class <- c("Black PWID", "Hispanic PWID", "White PWID")
num <- c(input$blackpwidprep, input$hisppwidprep, input$whitepwidprep)
perc <- c(input$blackpwiddiagpct, input$hisppwiddiagpct, input$whitepwiddiagpct)
colnames(df) <- c("Race", "Number with PrEP Indications", "Percent (%) of Total PWID diagnoses")
df[ , 1:3] <- c(class, num, perc)

# kable(df)

df_footnote <- df
df_footnote[3, 1] <- paste0(df_footnote[3, 1],
                                   footnote_marker_alphabet(1))
kable(df_footnote, "html", escape = FALSE) %>%
kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = F) %>%
footnote(alphabet = "Footnote for PWID; ",
           footnote_as_chunk = T)
```

### Figure 5: Individuals with Indications for PrEP by Race among PWID Transmission Risk Group

```{r echo=FALSE, message = FALSE, fig.cap=paste("Figure 5: Persons who Inject Drugs Indicated for PrEP by Race"), fig.width=8, fig.height=8}
pwidnums <- NULL
pwidnums$Individuals <- rbind(input$blackpwidprep, input$hisppwidprep, input$whitepwidprep)
pwidnums$Group <- c("Black", "Hispanic", "White")
pwidnums2 <- as.data.frame(pwidnums)
ggplot(data = pwidnums2, aes(x = Group, y = Individuals, fill = Group)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Individuals), vjust = 1.6, color = "white", size = 7) +
  scale_fill_manual("Race", values = c("darkblue","red", "green")) +
  theme_minimal() + labs(title = "PWID Indicated for PrEP by Race", 
         x = "Race", y = "Number of PWID") +
  theme(title = element_text(size = 15),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 11),
        legend.text = element_text(size = 9)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
```


### Table 6: Individuals with Indications for PrEP by Transmission Risk Group among Black Individuals

```{r echo = FALSE, message = FALSE} 
df <- matrix(nrow = 3, ncol = 3)
class <- c("Black MSM", "Black HET", "Black PWID")
num <- c(input$blackmsmprep, input$blackhetprep, input$blackhetprep)
sums <- sum(input$blackmsmprep, input$blackhetprep, input$blackpwidprep)
perc <- c(100 * input$blackmsmprep / sums, 100 * input$blackhetprep / sums, 100 * input$blackpwidprep / sums)
colnames(df) <- c("Risk Group", "Number with PrEP Indications", "Percent (%) of Total Black diagnoses")
df[ , 1:3] <- c(class, num, perc)

# kable(df)

df_footnote <- df
df_footnote[3, 1] <- paste0(df_footnote[3, 1],
                                   footnote_marker_alphabet(1))
kable(df_footnote, "html", escape = FALSE) %>%
kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = F) %>%
footnote(alphabet = "Footnote for PWID; ",
           footnote_as_chunk = T)
```

### Figure 6: Individuals with Indications for PrEP by Transmission Risk Group among Black Individuals

```{r echo=FALSE, message = FALSE, fig.cap=paste("Figure 6: Black Individuals Indicated for PrEP by Transmission Risk Group"), fig.width=8, fig.height=8}
blacknums <- NULL
blacknums$Individuals <- rbind(input$blackmsmprep, input$blackhetprep, input$blackpwidprep)
blacknums$Group <- c("MSM", "HET", "PWID")
blacknums2 <- as.data.frame(blacknums)
ggplot(data = blacknums2, aes(x = Group, y = Individuals, fill = Group)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Individuals), vjust = 1.6, color = "white", size = 7) +
  scale_fill_manual("Transmission Risk Group", values = c("darkblue","red", "green")) +
  theme_minimal() + labs(title = "Black Individuals Indicated for PrEP /n by Transmission Risk Group", 
         x = "Transmission Risk Group", y = "Number of Black Individuals") +
  theme(title = element_text(size = 15),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 11),
        legend.text = element_text(size = 9)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Table 7: Individuals with Indications for PrEP by Transmission Risk Group among Hispanic Individuals

```{r echo = FALSE, message = FALSE} 
df <- matrix(nrow = 3, ncol = 3)
class <- c("Hispanic MSM", "Hispanic HET", "Hispanic PWID")
num <- c(input$hispmsmprep, input$hisphetprep, input$hisphetprep)
sums <- sum(input$hispmsmprep, input$hisphetprep, input$hisppwidprep)
perc <- c(100 * input$hispmsmprep / sums, 100 * input$hisphetprep / sums, 100 * input$hisppwidprep / sums)
colnames(df) <- c("Risk Group", "Number with PrEP Indications", "Percent (%) of Total Hispanic diagnoses")
df[ , 1:3] <- c(class, num, perc)

# kable(df)

df_footnote <- df
df_footnote[3, 1] <- paste0(df_footnote[3, 1],
                                   footnote_marker_alphabet(1))
kable(df_footnote, "html", escape = FALSE) %>%
kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = F) %>%
footnote(alphabet = "Footnote for PWID; ",
           footnote_as_chunk = T)
```

### Figure 7: Individuals with Indications for PrEP by Transmission Risk Group among Hispanic Individuals

```{r echo=FALSE, message = FALSE, fig.cap=paste("Figure 7: Hispanic Individuals Indicated for PrEP by Transmission Risk Group"), fig.width=8, fig.height=8}
hispnums <- NULL
hispnums$Individuals <- rbind(input$hispmsmprep, input$hisphetprep, input$hisppwidprep)
hispnums$Group <- c("MSM", "HET", "PWID")
hispnums2 <- as.data.frame(hispnums)
ggplot(data = hispnums2, aes(x = Group, y = Individuals, fill = Group)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Individuals), vjust = 1.6, color = "white", size = 7) +
  scale_fill_manual("Transmission Risk Group", values = c("darkblue","red", "green")) +
  theme_minimal() + labs(title = "Hispanic Individuals Indicated for PrEP /n by Transmission Risk Group", 
         x = "Transmission Risk Group", y = "Number of Hispanic Individuals") +
  theme(title = element_text(size = 15),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 11),
        legend.text = element_text(size = 9)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
```

### Table 8: Individuals with Indications for PrEP by Transmission Risk Group among White Individuals

```{r echo = FALSE, message = FALSE} 
df <- matrix(nrow = 3, ncol = 3)
class <- c("White MSM", "White HET", "White PWID")
num <- c(input$whitemsmprep, input$whitehetprep, input$whitehetprep)
sums <- sum(input$whitemsmprep, input$whitehetprep, input$whitepwidprep)
perc <- c(100 * input$whitemsmprep / sums, 100 * input$whitehetprep / sums, 100 * input$whitepwidprep / sums)
colnames(df) <- c("Risk Group", "Number with PrEP Indications", "Percent (%) of Total White diagnoses")
df[ , 1:3] <- c(class, num, perc)

# kable(df)

df_footnote <- df
df_footnote[3, 1] <- paste0(df_footnote[3, 1],
                                   footnote_marker_alphabet(1))
kable(df_footnote, "html", escape = FALSE) %>%
kable_styling(bootstrap_options = c("striped", "hover", "bordered"), full_width = F) %>%
footnote(alphabet = "Footnote for PWID; ",
           footnote_as_chunk = T)
```

### Figure 8: Individuals with Indications for PrEP by Transmission Risk Group among White Individuals

```{r echo=FALSE, message = FALSE, fig.cap=paste("Figure 8: White Individuals Indicated for PrEP by Transmission Risk Group"), fig.width=8, fig.height=8}
whitenums <- NULL
whitenums$Individuals <- rbind(input$whitemsmprep, input$whitehetprep, input$whitepwidprep)
whitenums$Group <- c("MSM", "HET", "PWID")
whitenums2 <- as.data.frame(whitenums)
ggplot(data = whitenums2, aes(x = Group, y = Individuals, fill = Group)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Individuals), vjust = 1.6, color = "white", size = 7) +
  scale_fill_manual("Transmission Risk Group", values = c("darkblue","red", "green")) +
  theme_minimal() + labs(title = "White Individuals Indicated for PrEP /n by Transmission Risk Group", 
         x = "Transmission Risk Group", y = "Number of White Individuals") +
  theme(title = element_text(size = 15),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 11),
        legend.text = element_text(size = 9)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black"))
```
